\chapter{Šprecifikácia konkrétnych API tokenov}

\label{kap:typy} % id kapitoly pre prikaz ref

V tejto kapitole predstavíme v praxi využívané API tokeny, ktorými sa zaoberá naša práca. Uvedieme ich formát a základané charakteristiky ako ich vytvorenie, či validácia.

Ich využitie, výhody či nevýhody rozoberieme v kapitole \ref{kap:teoreticke}.

\section{JSON Web Token}

Prvý token, ktorým sa budeme zaoberať je JSON web token (JWT) \cite{jwt_rfc}. JWT vznikol ako súčasť JOSE \cite{jose_rfc} (JSON object signing and encryption) štandardov, čo je dokument vypracovaný pracovnou skupinou IETF (Internet Engineering Task Force) na základe aplikácií bezpečnostných mechanizmov v rámci vývoja softvéru. Tieto štandardy popisujú využitie a definujú požiadavky na objekty formátu JSON, ktoré sú bezpečné.

Definujú štandard pre bezpečný prenos JSON objektov medzi stranami, ktoré sú schopné ich overiť a dešifrovať. Zavádzajú tri základné formáty JSON objektov a to JWS (JSON Web Signature), JWE (JSON Web Encryption) a JWK (JSON Web Key), ktorým sa detailnejšie venujú ďalšie štandardy \cite{jws_rfc, jwe_rfc, jwk_rfc}. Prvé dva sú formáty zabezpečujúce bezpečnostné vlastnosti JSON objektov. Oba zabezpečujú autentickosť a integritu pomocou elektronických podpisov alebo hešovaného autentifikačného kódu (HMAC) \cite{hmac}, ďalej budeme hovoriť v oboch prípadoch o podpise tokenu. JWE navyše zabezpečuje aj dôvernosť a to šifrovaním obsahu JSON objektu. Posledný formát JWK je formát pre reprezentáciu kľúčov, ktoré sú použité v kryptografických algoritmoch využitých v JWS a JWE. Kryptografické algortimy a ich identifikátory sú definované JSON
Web Algorithms (JWA) štandardom \cite{jwa_rfc}.

\subsection{Štruktúra JWT}

Samotný JWT je vpodstate iba serializácia JSON objektu chráneného JWS alebo JWE. Podľa štandardu JWT obsahuje tri samostatné časti oddelené bodkami - hlavičku, telo a podpis. Hlavička a telo sú serializované JSON objekty obsahujúce oprávnenia (angl. claim) vo forme dvojíc kľúč, hodnota. Niektoré kľúče niektorých oprávnení sú definované v štandarde a teda by sa nemali používať pre žiadne iné hodnoty. 

A to konkrétne v hlavičke najdôležitejšie sú \textit{typ} a \textit{alg}. Prvý určuje typ tokenu a druhý algoritmus, ktorý bol použitý na vytvorenie podpisu alebo vrámci šiforvania obsahu tokenu. Rôzne možnosti pre algortimy sú definované v JWA štandardoch.

Telo tvorí logický obsah tokenu, napríklad môže obsahovať oprávnenia týkajúce sa kontrétnej autentifikácie a používateľa, pre ktorého bol token vydaný. Dôležité Štandardom popísané kľúče sú napríklad \textit{iss}, \textit{sub}, \textit{exp}, \textit{nbf}, \textit{iat}. Popisujú postupne vydavateľa tokenu, identifikátor používateľa, čas vypršania platnosti tokenu, čas, kedy sa token začne považovať za platný a čas vydania tokenu.

Do tela aj hlavičky sa môžu vkladať ľubovoľné iné oprávnenia, naprílad \textit{admin}, \textit{role}, \textit{permissions}, určujúce oprávnenia používateľa.

\subsection{Generovanie a validácia JWT}

Hlavička a telo sa serializujú pomocou base64url kódovania \cite{base64_rfc}. V prípade JWE sa telo ešte šifruje. Následne sa obe časti podpíšu algoritmom definovaným v hlavičke a podpis sa zreťazí s hlavičkou a telom. Výsledný reťazec sa používa ako token.

Na overenie platnosti tokenu treba zvalidovať podpis. Podpis je vytvorený pomocou algoritmu definovanom v hlavičke. Teda pri validácii tokenu sa ako prvé dekóduje hlavička tokenu a z nej sa prečíta hodnota v kľúči \textit{alg}.

Na základe hodnoty v kľúči \textit{alg} sa určí algoritmus, ktorý bol použitý na podpis tokenu. Následne sa podpis zvaliduje. 

Ak bol token vytvorený pomocou JWE, na prečítanie tela je potrebné ho najprv dešifrovať. V prípade využitia JWS je telo po dekódovaní priamo čitateľné. Následne môžeme overiť informácie o časovej platnosti tokenu, či právach používateľa a pod.

\section{Platform Agnostic SEcurity TOken}

Platform Agnostic SEcurity TOken (PASETO) je relatívne nový štandard tokenu navrhnutý v roku 2018 a je stále v štádiu RFC draftu \cite{paseto_rfc}. Je inšpirovaný rodinov štandardov JOSE (JWT, JWS, JWE, JWK). Jednoducho povedané sa snaží zjednodušiť implementáciu a použitie kryptografických funkcií.

Rovanko ako JWT, PASETO serializuje JSON objekty a zaručuje rôzne bezpečnostné kvality pri ich prenose cez internet. Pôvodne bol PASETO navrhnutý s dvoma verziami \textit{v1} a \textit{v2} líšiacimi sa v použitých kryptografických algoritmoch. Dnes už existujú štyri verzie \textit{v1}, \textit{v2}, \textit{v3} a \textit{v4} popísané štandardom \cite{paseto_git}. Každá verzia tokenu zaručuje autentickosť a integritu obsahu tokenu a to pomocou asymetrického šifrovania v zmysle elektronického podpisu alebo pomocou hešovaného autentifikačného kódu (HMAC) \cite{hmac}. Obe tieto možnosti budeme nazývať podpis a proces ich vytvárania podpisovanie.

\subsection{Verzie PASETO}

Ako sme spomenuli PASETO má štyri verzie. Každá verzia sa delí na dve ďalsie podľa ich využitia na lokálne a verejné. Lokálne tokeny majú zašifrované telo a tým zabezpečujú dôvernosť dát uložených v tele tokenu. Narozdiel od toho sú verejené tokene nešifrované a dáta v ich tele sú čitateľné pre kohokoľvek s prístupom k danému tokenu.

Každá verzia PASETO používa iný algoritmus na podpisovanie a prípadne šifrovanie tokenu v prípade lokálnych tokenov. Jednotlivé algortimy pre konkrétne verzie a ich použitie je popísané v špecifikácii \cite{paseto_git}.

Novšie verzie \textit{v3} a \textit{v4} prinášajú modernejšie kryptografické algortmy a pridávajú niektoré funkcionality. Napríklad verzia \textit{v3} prináša nepopierateľnosť autorstva ako novú bezpečnostnú kvalitu. Dosahuje to dokonca bez predĺženia podpisu a to pomocou pridania verejného kľuča do tokenu pred vypočítaním podpisu \cite{ueo}. Tiež zavádza podporu pre implicitné informácie, teda také informácie, ktoré nie sú uložené priamo v tokene, ale používajú sa pri výpočte podpisu. Teda sú to informácie potrebné pre validáciu tokenu, ale z nejakého dôvodu nie je vhodné ich vkladať priamo do tokenu. Napríklad môže ísť o citlivé interné dáta. Podrobná motivácia za zavedením nových verzií je popísaná v špecifikácii \cite{paseto_git}.

\subsection{Štruktúra PASETO}

PASETO sa skladá z troch alebo štyroch častí zreťazených bodkov. Časti postupne reprezentujú verziu, využitie, telo a pätu. Prvé tri časti sú povinné a päta je nepovinná, ale dovoľuje nám zapísať akékoľvek ďalšie informácie do tokenu.

\begin{itemize}
    \item Verzia - reprezentuje verziu PASETO. Môže byť \textit{v1}, \textit{v2}, \textit{v3} alebo \textit{v4}.
    \item Využitie - určuje využitie tokenu ako lokálne alebo verejné. Možné hodnoty sú \textit{local} alebo \textit{public}.
    \item Telo - reprezentuje samotné dáta uložené v tokene. Podobne ako pri JWT ide o oprávnenia vo forme dvojíc kľúč hodnota a rovnako sú niektoré doležité kľúče sú definované špecifikáciou. \cite{paseto_git}
    \item Päta - môže obsahovať ľubovoľné ďalšie informácie.
\end{itemize}

Telo a päta sú vo forme JSON objektu, ktorý je serializovaný pomocou \textit{base64url} \cite{base64_rfc}.

\subsection{Generovanie a validácia PASETO}

Pri vytváraní tokenu sa musíme najprv rozhodnúť pre verziu a využitie podľa toho aké bezpečnosté požiadavky máme na token. Následne vytvoríme telo tokenu obsahujúce informácie, ktoré chceme pomocou tokenu prenášať, napríklad informácie o vzniku tokenu, jeho platnosti, jeho autorovi, či určenému subjektu. Ďalej môžeme pridať ďalšie informácie do päty tokenu ako napríklad identifikátor kľúča kryptografickej funkcie. 

Ak sme zvolili lokálne využitie, tak telo tokenu zašifrujeme. Následne vypočítame podpis z tela a päty tokenu. Šifrovanie aj podpisovanie sa deje pomocou kryptografickej funkcie vybraj podľa verzie a využitia.

Nakoniec všetky časti spojíme do jedného reťazca a oddelíme bodkami.

Validácia je tokenu je inverzný proces ku generovaniu. Najprv rozdelíme reťazec na časti a zistíme verziu a využitie tokenu a podľa toho vyberieme použitú kryptografickú funkciu. Následne zistíme, či je podpis tokenu platný pomocou adekvátnej kryptografickej funkcie a kľúča. Ak mal token lokálne využitie dešifrujeme jeho telo a skontrolujeme časovú plastnosť tokenu, ak to využívaná schéma podporuje a telo obsahuje informácie o platnosti tokenu.

\section{Fernet}

(Názov tohto tokenu je naozaj inšpirovaný známym nápojom. haha aka som vtipna :D) Pôvodne Fernet vznikol ako nástroj na zasielanie bezpečných správ v platforme cloudových služieb Heroku \cite{fernet_legacy}. V súčasnosti už podľa špecifikácie \cite{fernet_spec} vzniklo veľa implementácií Fernetu v rôznych programovacých jazyok \cite{fenet_cpp, fernet_haskell}, v rámci Heroku bol implementovaný v Ruby. Fernet bol dokonca vybratý PYCA (Python Cryptographic Authority) \cite{pyca_crypto} ako štandard pre implementáciu symetrického šifrovania v Pythone.

Fernet je štruktúrovaný token, lebo v sebe nesie rôzne informácie, no nijak nešpecifikuje formát týchto informácií. Väčšina implementácií s nimi pracuje ako s obyčajným reťazcom znakov. 

Token je navrhnutý s možnosťou pridania viacerých verzií, no v súčasnosti existuje len jedeina verzia. V tejto verzií je obsah tokenu zašifrovaný pomocou AES-128-CBC \cite{aes_cbc} a celý token je podpísaný pomocou HMAC-SHA256 \cite{hmac}. Z toho vyplýva, že Fernet zaručuje autentickosť, integritu a dôvernosť. 

\subsection{Štruktúra Fernet}

Fernet sa skladá z piatich zreťazených častí. Každá časť reprezentuje jednu informáciu o tokene. Jednotlivé časti sú nasledovné:

\begin{itemize}
    \item Verzia - reprezentuje verziu Fernet tokenu, aktuálne existuje len jedna verzia a je reprezentovaná číslom 0x80. Zaberá vždy 8 bitov.
    \item Časová pečiatka - reprezentuje čas vytvorenia tokenu. Čas je zachytení ako počet sekúd od 1.1.1970 v UTC časovej zóne. Zaberá vždy 64 bitov.
    \item Inicializačný vektor (IV) - reprezentuje náhodný reťazec znakov, ktorý je použitý pri šifrovaní a dešifrovaní tokenu. IV musí byť unikátny a najmä nepredvídateľný pre každý token, preto sa generuje náhodnou funkciou. Zaberá vždy 128 bitov.
    \item Zašifrované telo - reprezentuje zašifrované dáta uložené v tokene. Môže mať premenlivú dĺžku, no vždy násobok 128 bitov.
    \item HMAC - reprezentuje výstup HMAC-SHA256 funkcie a zaberá vždy 256 bitov.
\end{itemize}

Ako vidíme, všetky časti tokenu okrem tela majú pevne danú dĺžku. Vďaka tejto vlastnosti nemusia byť zreťazené časti oddelené žiadnym špeciálnym symbolom, napríklad bodkou, lebo vieme jednoznačne oddeliť verziu, časovú pečiatku, IV aj HMAC a tým pádom aj zašifrované telo.

Pre jednoduché prenášanie je celý token zakódovaný pomocou \textit{base64url} \cite{base64_rfc}.

\subsection{Generovanie a validácia Fernet}

Pri generovaní Fernet tokenu sa využívajú dva kryptografické algoritmy, ktoré vyžadujú kľúč. Fernet definuje 256 kľúč, ktorý je rozdelený na dve 128 bitové časti. Prvá časť reprezentuje podpisový kľúč a druhá šifrovací kľúč.

Existuje iba jedna verzia tokenu, teda tú máme danú. Pre vygenerovanie tokenu, potrebujeme zaznamenaý aktuálny čas do časovej pečiatky a vygenerovať náhodný reťazec, ktorý bude slúžiť ako IV. Následne zašifrujeme telo tokenu pomocou šifrovacieho kľúča a IV. Ďalej vypočítame HMAC z predchádzajúcich častí tokenu pomocou podpisového kľúča. Nakoniec a všetky časti spojíme do jedného reťazca a zakódujeme pomocou textit{base64url} \cite{base64_rfc}.

Validácia tokenu spočíva v dekódovaní tokenu, rozdelení na časti a overení časovej pečiatky a HMAC. Potom dešifrujeme telo toknu pomocou šifrovacieho kľúča a IV. Následne prípadne overíme časovú plastnosť tokenu, ak telo obsahuje potrebné informácie pre overenie časovej platnosti ako vznik a doba platnosti tokenu.